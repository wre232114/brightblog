<!DOCTYPE html>
<html>

  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
    <title>
      
        服务器部署 |
          
            Bright的个人博客
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/css/reset.css">
      <link rel="stylesheet" href="/css/style.css">
        <link rel="stylesheet" href="/css/github-markdown.css">
          <link rel="stylesheet" href="/css/atom-one-dark.css">
            
</head>

    <body>
      
        <header id="header" class="card">
  <span class="logo">B</span>
  <span class="motto">技术 & 梦想 |&nbsp;学习 & 总结</span>
  <nav>
    <ul>
    
      <li>
        <a href="/">首页 </a>
      </li>
    
      <li>
        <a href="/archives">归档 </a>
      </li>
    
      <li>
        <a href="/categories">分类 </a>
      </li>
    
      <li>
        <div class="search-input">
          <i class="fa search"></i>
          <input id="search-input" type="text">
        </div>
      </li>
    </ul>
  </nav>
</header>
          <main id="main">
            
              
<aside id="left-sidebar" class="margin-right">
  <nav class="card sidebar-component">
  <div class="card-title">文章归档</div>
  <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">30</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li></ul>
</nav>
  <nav class="card sidebar-component">
  <div class="card-title">文章分类</div>
  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">10</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/css/css基础/">css基础</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/css工具/">css工具</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/less/">less</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/sass/">sass</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/docker-swarm/">docker swarm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/docker基础/">docker基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/">html5</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/html5/dom/">dom</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/html5-API/">html5 API</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/html5标签和属性/">html5标签和属性</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/svg/">svg</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/tips/">tips</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/实战/">实战</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/spring实战/">spring实战</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/js基础/">js基础</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/typescript/">typescript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/正则表达式/">正则表达式</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/工具/">工具</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/">node.js</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/npm/">npm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/命令行工具/">命令行工具</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring-boot/">spring-boot</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/spring-boot/开发工具/">开发工具</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/typescript/">typescript</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/typescript/踩坑指南/">踩坑指南</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/vue/cli/">cli</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/tips/">tips</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue-router/">vue-router</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue实战/">vue实战</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue组件开发/">vue组件开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/基础/">基础</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/webpack基础/">webpack基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/xml/">xml</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/xml/基础/">基础</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习打卡/">学习打卡</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/安全/密码技术/">密码技术</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">23</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/shell/">shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/ucore/">ucore</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/操作系统原理/">操作系统原理</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">10</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/mysql/">mysql</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/sql语句/">sql语句</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/导论/">导论</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/数据库编程/">数据库编程</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/数据库设计/">数据库设计</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/">数据结构</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构/图/">图</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/毕设/">毕设</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">20</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/算法/leetcode/">leetcode</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/模式匹配/">模式匹配</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/深度优先搜索/">深度优先搜索</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/">编程语言</a><span class="category-list-count">20</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/C/">C</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/C/语言/">语言</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/C语言/">C语言</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程语言/java/">java</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/英语/">英语</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/英语/生词/">生词</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/wireshark/">wireshark</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/交给子类/">交给子类</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/生成实例/">生成实例</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/适应设计模式/">适应设计模式</a><span class="category-list-count">2</span></li></ul></li></ul>
</nav>
  <nav class="card sidebar-component">
  <div class="card-title">最近文章</div>
  <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/19/algorithm/leetcode/动态规划/interleaving-string/">interleaving string</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/17/algorithm/leetcode/分治/maximum-product-subarray/">maximum product subarray</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/15/algorithm/leetcode/动态规划/triangle/">triangle</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/algorithm/leetcode/动态规划/unique-binary-search-trees-ii/">unique binary search trees ii</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/algorithm/leetcode/动态规划/decode-ways/">decode-ways</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/algorithm/leetcode/动态规划/unique-path-II/">unique path II</a></li></ul>
</nav>
</aside>


                <!--
<aside id="right-sidebar">
  <nav class="card margin-bottom">
  
</nav>
</aside>

-->
                <article id="article" class="margin-right ofhidn">
                  <article class="post-article article markdown-body">
  <h1>
    服务器部署
  </h1>
  <hr>
  <p>毕设终于开发完成了大部分的基础功能，接下来就是进行部署了。计划使用三台服务器进行部署，一台用作静态资源服务器和反向代理服务器，另外两台作为后端服务集群，采用容器化方式部署。</p>
<p>主要解决的问题是：</p>
<ol>
<li>后端服务的架构：mysql、redis、java代码是部署在一台机器上还是分离部署？</li>
<li>容器如何编排？使用nginx的反向代理还是kubernates？各有什么优势和劣势？</li>
<li>容器之间的状态如何保持一致？mysql、redis如何保证多台机器上的数据一致性？如何保证用户的登陆态在多台机器上是一致的？</li>
<li>发布后自动部署</li>
</ol>
<p>首先我们进行一些基础知识的学习，主要是服务器部署架构的基础知识，主要参考《大型网站技术架构——核心原理与案例分析》，主要学习的知识是大型网站架构的演进，大型网站的指标和主要使用的技术。然后即行docker基础知识的学习。然后是mysql、redis一致性的解决。</p>
<h2 id="大型网站技术架构"><a href="#大型网站技术架构" class="headerlink" title="大型网站技术架构"></a>大型网站技术架构</h2><p>该部分主要分为以下知识点</p>
<ul>
<li>概述<ul>
<li>大型网站架构演化的发展历程<ul>
<li><strong>1.初始阶段的网站架构</strong>：用户量小时，一台服务器提供服务绰绰有余。数据库，文件、web服务器运行在一台机器上</li>
<li><strong>2.应用服务和数据服务分离</strong>：用户量增加，越来越多的用户访问导致服务器负载越来越高、数据越来越多，一台服务器不够了。这是将数据和服务分离，使用三台服务器，分别部署应用服务器、文件服务器和数据库服务器。<strong>不同的服务器拥有不同的能力，应用服务器需要更快的CPU；数据库服务器需要快速硬盘和更大的内存；文件服务器需要更大的硬盘。</strong></li>
<li><strong>3.使用缓存改善性能</strong>：二八定律，80%的访问集中在20%的数据上，缓存热点数据可以减少数据库访问压力。<strong>缓存有本地缓存和缓存在远程服务器上的分布式缓存。</strong></li>
<li><strong>4.使用应用服务器集群改善网站的并发处理能力</strong>：当用户继续增加，一台应用服务器不足以处理所有的请求，这时候就需要使用额外的应用服务器来处理额外的请求。添加应用服务器集群。通过负载均衡服务器来确定提供服务的服务器。</li>
<li><strong>5.数据库读写分离：缓存可以大大减小数据库的压力。但是仍然有一部分操作需要访问数据库（缓存过期、缓存未命中、数据库写操作）</strong>。可以通过数据库的主从关系来实现读写分离。写数据访问主服务器，而读数据访问从服务器，通过主从复制同步数据。</li>
<li><strong>6.使用反向代理和CDN加速网站响应</strong>：用户规模越来越大，用户可能分布在相距较远的多个地域。在广州的用户访问在广州的服务器，肯定比北京的用户访问广州的服务器延迟低。CDN和反向代理的基本原理都是缓存，区别是CDN部署在网络提供商的机房，用户可以从距离最近的网络提供商获取数据。反向代理服务器部署在中心机房，用于缓存，在应用服务器之前。</li>
<li><strong>7.使用分布式文件系统和分布式数据库系统</strong>：一台数据服务器分成两台，当用户量持续增加的时候，两台数据库服务器也不够了，这时候需要使用分布式数据库。只有在单表数据规模非常庞大的时候才使用分布式数据库。不到不得已时，网站更常用的拆分手段是分库，将不同业务的数据库部署在不同的物理服务器上。</li>
<li><strong>8.使用NoSQL和搜索引擎实现数据存储和搜索</strong>：全文检索、NoSQL用于解决增长的数据和搜索需求</li>
<li><strong>9.业务拆分</strong>：随着业务扩展，系统会变得越来越庞大，可以通过通过业务拆分划分为多个子系统，由不同的团队负责，部署在不同的服务器集群上。例如首页、商品页分开部署，这样可以降低一个系统的复杂度，便于发布和管理。<strong>通过消息队列和访问同一个数据存储系统来实现不同模块之间的关联</strong></li>
<li><strong>10.分布式服务</strong>：业务继续扩张，拆分的拆分的子系统也会变得越来越复杂，而且子系统中有很多可以共用的部分。这时可以通过提取共用的服务作为底层支撑，并将这些服务进行独立的集群部署。查分的多个业务远程调用这些服务。</li>
</ul>
</li>
<li>大型网站架构模式</li>
<li>大型网站核心架构要素</li>
</ul>
</li>
<li>架构<ul>
<li>瞬时响应：网站的高性能架构</li>
<li>万无一失：网站的高可用架构</li>
<li>永无止境：网站的伸缩性架构</li>
<li>随需应变：网站的可扩展性架构</li>
<li>固若金汤：网站的安全架构</li>
</ul>
</li>
<li>案例<ul>
<li>淘宝网的架构演化方案</li>
<li>维基百科的高性能架构设计分析</li>
<li>海量分布式存储系统Doris的高可用架构设计分析</li>
<li>网购秒杀系统架构设计案例分析</li>
<li>大型网站典型故障案例分析</li>
</ul>
</li>
<li>架构师<ul>
<li>架构师领导艺术</li>
<li>网站架构师职场攻略</li>
<li>漫话网站架构师</li>
</ul>
</li>
</ul>
<h2 id="后端的服务架构设计"><a href="#后端的服务架构设计" class="headerlink" title="后端的服务架构设计"></a>后端的服务架构设计</h2><p>虽然只有三台物理服务器，但是每一台服务器上可以部署多个容器，容器可以视作抽象的服务器。<strong>按照推荐，每一个容器仅仅只运行一个应用</strong>。例如mysql和redis运行在两个不同的容器中，通过配置dockerfile和使用docker命令参数，让他们从容器中暴露出自己的端口，从而能够从外界访问。</p>
<blockquote>
<p>推荐使用在一个容器中只运行一个进程，虽然一个容器中可以执行多个进程。如果需要一个容器中执行多个进程，那么最好使用进程管理工具来负责容器中进程的启动和监视。自己使用脚本来启动多个进程也可以，但是需要自己处理进程间信号的转发和进程结束之后的善后处理。</p>
</blockquote>
<p>这样从外界看来，虽然只有三台物理机器，但是实际上能够达到模拟若干台机器的效果。当一台机器的计算资源和存储资源有余时，一台物理机器上部署多个服务例如mysql、redis、应用是没有问题的。但是当用户量增大时，会有服务成为瓶颈，这时候需要增加相应的机器，将服务分离开，以提供更多的计算资源、内存资源、硬盘空间。<strong>当一台机器的计算资源有余时，部署多个容器是有优势的，能够充分利用一台机器的性能，不会造成资源空闲。</strong></p>
<p>那三台机器，分别部署不同的服务（分别是redis、应用、mysql），还是每台机器都部署服务的一部分做分布式部署呢？这也要看情况，例如在各个服务器部署不同的服务的时候，假设数据服务器的硬盘资源到达了瓶颈，而应用服务器的计算资源和硬盘资源都有富余，那么可以在应用服务器上再部署数据容器，利用应用服务器的资源减轻数据服务器的压力。反过来同理，数据服务器的计算能力有大量富余，那么可以将应用容器部署到数据服务器，以利用数据服务器的计算资源。</p>
<p><strong>总之，具体采取怎样的设计架构需要根据具体资源的分配情况来定，没有决定的优劣。</strong>在本次毕设的服务器部署中，设计在两台后端服务器上都部署redis、mysql、应用容器，这些服务器上的容器分别组成应用集群、数据库集群、缓存集群。</p>
<blockquote>
<p>集群的引入当然会产生与单机相比更多的开销，例如集群间需要通过网络进行通信，负载调度。但是这些是引入额外的机器必须的开销，两台机器并不能起到一台机器两倍的效果，但是可以起到1.8倍甚至更高的效果。额外的网络通信也会增加一定量的访问延迟，这些都是不可避免的，可以通过引入额外的缓存来尽量减少这些访问延迟。</p>
</blockquote>
<h2 id="数据一致性的保证"><a href="#数据一致性的保证" class="headerlink" title="数据一致性的保证"></a>数据一致性的保证</h2><p>多台机器上的数据如何保持同步？这一块主要解决这个问题。</p>
<h3 id="mysql数据库"><a href="#mysql数据库" class="headerlink" title="mysql数据库"></a>mysql数据库</h3><p>mysql数据库通过主从复制来保证，在主服务器上写，在从服务器上读，实现读写分离。在java中通过mysql连接中间件实现读写分离，在java端看起来就像只有一个节点，中间件通过对sql语句的分析来决定使用哪一个源，mysql读写分离的需要两部分的支持：</p>
<ol>
<li>mysql数据库开启主从同步机制</li>
<li>java通过中间件连接mysql，然后在中间件中配置读写的mysql数据库地址</li>
</ol>
<p>mysql数据库运行在docker容器中，使用相同的镜像，保证mysql的版本，环境都是完全相同的。</p>
<h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><p>redis也带有读写分离的的机制，但是更高效的方式是使用redis集群</p>
<h2 id="项目发布设计"><a href="#项目发布设计" class="headerlink" title="项目发布设计"></a>项目发布设计</h2><p>将代码发布到集群上的一台机器上，然后在该机器上重新构建，生成新的image，再将该image通过k8s的更新机制自动同步到该服务的其他的节点。该过程需要以下技术的支持：</p>
<ul>
<li>git hooks：再特定分支上提交代码以后，触发git hooks，通过执行特定的shell脚本触发新的image的build过程。构建成功之后，再通过shell脚本将结果自动更新到集群上。（待添加自动化测试、构建失败的反馈）</li>
<li>shell脚本：linux平台上的脚本语言，可以以编程语言的方式执行linux命令。</li>
<li>docker image构建：利用docker create重新从dockerfile和源代码构建一个新的image，这个image通过一个新的版本号标识。<strong>容器中只运行打包过后的jar包，而不包括maven等环境，以减少image的大小</strong></li>
<li>k8s更新：通过set image命令告诉k8s集群对特定的部署使用新的image，这个过程k8s会自动热重启</li>
</ul>
<p>本来想使用k8s做集群部署，但是发现k8s对机器配置有要求，2核2G是最基础的配置，然后最好至少要三个节点，master节点不部署容器（虽然可以通过修改配置部署容器）。k8s是企业使用的大规模容器管理工具，我这low的配置就还是不上了，看了两天文章，当作了解k8s的基础概念了。</p>
<p>现在打算使用docker自带的swarm来实现。在docker 1.12之后swarm已经集成到了docker引擎中，可以很方便的扩展到集群。同时swarm也支持负载均衡，滚动发布等。</p>
<h2 id="部署全过程细节"><a href="#部署全过程细节" class="headerlink" title="部署全过程细节"></a>部署全过程细节</h2><p>这里记录了部署的全过程步骤，先看一下概览：</p>
<ul>
<li>学习docker，主要关注docker核心概念，Dockerfile的结构和命令，以及docker命令行工具的常用命令。核心概念包括，镜像、容器、镜像分层、数据卷挂载、端口、网络路由、通过namespace实现进程隔离、通过cgroup实现资源隔离等等。</li>
<li>学习基于docker的集群方案，了解的有swarm和kubernetes，kubernetes是google开源的方案，拥有比swarm更强大的功能，但是对硬件要求高一些。swarm是docker官方的方案，想对来说功能少一些，更简单，硬件要求也低很多。</li>
<li>基于集群规模和机器配置选择swarm进行部署。需要了解swarm的核心概念，包括服务、manager/worker、docker service、docker node命令等、docker config</li>
<li>搭建私有registry，参考官方文档就行，需要使用ssl，或者配制非安全的仓库选项。</li>
<li>学习mysql的主从复制，主要是如何在mysql上开启主从复制</li>
<li>学习mycat的读写分库配置和安装，利用docker.mycat库，以及docker-compose。（这里需要安装docker-compose，从github下载太慢，使用pip安装的又执行不了，最后的解决方案是下载预发布版本</li>
<li>学习redis cluster和redis主从复制方案，redis cluster最少需要3个主节点，因为在spring-boot中实现读写分离需要非常多额外的配置，并不像mycat中那么简单，最后决定使用redis cluster，只启动三个主节点，不启动从节点。<strong>这里需要注意，按照官方文档来，在最后一步会卡住，因为官方文档只在单机上运行，多机上需要按照提示，登陆每台机器的redis服务器，执行cluster meet 6379 16379命令。同时注意开放端口，例如阿里云需要在后台配置开放的端口。</strong></li>
<li>nginx集群服务和文件图片上传。nginx中主要存放两部分的资源，一个是nginx的配置文件和https配置；另一个是前端静态资源的配置，前台和后台使用不同的域名访问，前台使用<code>brightasdream.cn</code>域名，后台使用<code>admin.brightasdream.cn</code>子域名，前台和后台的代码都放在一个docker nginx容器中，通过配置文件中配置不同的域名来访问不同的资源。代码通过Makefile基于nginx容器构建新的容器，配置文件也写在源代码中。<strong>文件上传使用单独的服务，因为nginx要保持服务的一致性，所以不在单独的nginx服务下提供文件访问的能力，这里启动一个单独的java容器用做图片文件服务器，预览时直接上传图片，删除预览图片则通知文件服务器将图片删除</strong>。这里不引入HDFS等分布式文件系统了，因为数据量小，且机器数量和配置有限。</li>
</ul>
<p>上述的学习资源主要都来自于官方文档和书籍，下面的每一章都会注明参考资料的来源，便于复习参考。</p>
<h2 id="CI-CD的实现"><a href="#CI-CD的实现" class="headerlink" title="CI/CD的实现"></a>CI/CD的实现</h2><p>Docker有jenkins等框架来帮助CI/CD的实现，我们的需求比较简单就不使用。jenkins是一个单独的Docker容器，当有代码推送到jenkins中，会自动触发自动测试，构建新镜像，推送镜像等，同时提供了web界面。</p>
<p>我们打算使用shell脚本来完全实现CI/CD，通过在swarm的manager节点上建立git仓库，然后将代码推送到该仓库，当仓库接收到提交时，触发git hook，git hook根据commit的的message信息来决定构建哪一个子项目。<strong>这里这里应该使用git submodule来实现，但是由于项目开始的时候没想那么多，放在一个git仓库中，又不想丢失commit记录，只能自定一个commit mesasge规范来决定构建哪一个子项目了。</strong></p>
<p>当git commit信息中包含<code>build backend:</code>时，构建后端服务的镜像，包含<code>build frontend</code>时，构建前端镜像，包括前台和admin。</p>
<h2 id="排坑"><a href="#排坑" class="headerlink" title="排坑"></a>排坑</h2><p>mycat连接时，读没没有问题，写会包Connecttion is readonly错误，解决方案看：</p>
<p><a href="https://blog.csdn.net/aa292016616/article/details/82736054。" target="_blank" rel="noopener">https://blog.csdn.net/aa292016616/article/details/82736054。</a></p>
<p>卡了两天的mycat，最终还是没有解决主键报报NullPointerException的问题，也没有解决多条件查询的问题。最终的解决方案是不使用mycat，在spring boot中做读写分离，配置多个jpa数据源，通过继承AbstractRoutingDataSource自定义jpa数据源路由的选择。要注意几个坑：</p>
<ol>
<li>AOP选择数据源要定义在controller上，而不是service，因为我的controller可能会同时有读写的service，如果在读的service上配置了读库，后面的写就会写到读库上。<strong>因为同一次请求用的是同一个数据源</strong></li>
<li>jpa的默认事务是只读的，这也是连接mycat的时候会报conneciton is readonly的原因。在事务开始的时候，不根据当前事务是只读的来选择数据源，因为当前项目没有事务的需求。</li>
<li>实体的属性的名称和数据库表名不一样，那么需要使用<code>@Column</code>来自定义对数据库表名的映射（不会自动转化驼峰式的命名）</li>
</ol>
<p>参考：<a href="https://blog.csdn.net/dusuanyun/article/details/81059535" target="_blank" rel="noopener">https://blog.csdn.net/dusuanyun/article/details/81059535</a></p>

</article>
                </article>
          </main>
          <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Bright<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
<script src="/js/script.js"></script>
    </body>

</html>