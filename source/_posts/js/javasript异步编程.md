---
title: javasript异步编程
date: 2020-05-03 09:54:25
tags:
- js
- 异步编程
---
javascript的异步编程的核心是事件循环，js的运行环境有浏览器和nodejs，两者的异步模型有相似之处，也有不同。这篇文章主要总结javascript在浏览器和nodejs中的事件循环的细节，以及异步编程的解决方案：回调函数、Promise、generator函数、自动执行的generaor函数、async函数。

## 事件循环
javascript的执行是单进程单线程的，不管是在浏览还是在node中。js通过事件循环来处理异步任务。当启动一个异步任务之后，例如发起一个网络请求，该请求会交给js引擎去处理，js引擎会维护线程池来进行处理异步任务。当线程池中的异步任务完成以后，会将该异步任务的回调函数加入到事件队列中。事件队列中的任务会依次执行，当事件队列中的一个回调执行完成以后，js引擎会从事件队列中拿下一个回调函数执行，如此反复。

如果事件队列中的回调执行时又触发了异步任务，那么会继续入队。当事件队列为空时，会执行一个idle任务，该任务一直循环，检查任务队列是否为空，如果不空就会调用该任务。在程序最开始执行的时候，异步队列为空，主线程执行脚本，遇到异步任务时就会处理异步任务并进行入队的处理。

在nodejs中，如果线程池中还有异步任务在执行或任务队列不为空，那么该node进程不会退出，只有所有异步任务都执行完成了进程才会退出。

在事件循环中有宏任务和微任务的区别，js引擎处理任务队列的时候会先处理微任务、再处理宏任务。常见的微任务有Promise的回调、node的process.nextTick等，常见的宏任务有setTimeout、setInterval等。

**上面的事件循环是适用于浏览器和node环境的通过规则，但是node和浏览器的事件循环还是有一些区别的，接下来详细分析。**

### node的事件循环
