---
title: ucore-os-lab1：练习3、练习4
date: 2019-12-22 09:49:15
tags:
- 操作系统
- ucore

category:
- 操作系统
- ucore
---
练习三需要分析如何从实模式进入保护模式，重点是：
* 为何开启A20以及如何开启A20？
* 如何初始化GDT表？
* 如何使能和进入保护模式？

详细的解释请看[ucore-os笔记4：bois和bootloader](#)。这里只给出简单解释：

1. 在实模式下只能访问1MB的内存，这是为了向下兼容，所以实模式下禁用了第21根地址线保证最大只能访问1MB内存。为了硬件设计成本的考虑，A20的控制放在键盘控制器中，需要设置键盘控制器内部输出端口的对应位来开启。如果不开启A20，第21根地址线就无法使用，保护模式下不能完整的访问4G内存。
2. 需要将GDT表放置到内存中，表项是8字节大小，按照一定的结构存储。然后需要将GDT表的入口地址（线性地址）和大小放到GDTR寄存器中，使用lgdt指令可以设置GDTR寄存器，lgdt指令只能在特权为0的情况下使用
3. 使用保护模式，需要设置CRO寄存器中的PE位来开启保护模式，然后通过ljmp设置cs寄存器，mov设置其他的段寄存器。之后的内存访问就使用分段机制了。

练习4分析bootloader如何加载ELF格式的OS。这里需要了解：
* ELF格式的结构？
* 如何读取硬盘扇区？
* 如何加载ELF格式的OS？

详细信息都在[ucore-os笔记4：bois和bootloader](#)中。下面是简单的回答：
1. ELF格式分成ELF header和多个段。ELF可以分成可执行、链接库等等格式，可执行中最终要的elf program header。elf header中给出了elf program header的偏移和项数，elf program header是一个数组，每一项表示一个段的偏移、大小和起始虚拟地址，通过偏移+文件大小可以知道段在elf文件中的位置，将其加载到内存中对应的虚拟地址的位置即可。（虚拟地址是由链接器决定的，在编译时就确定了在其地址空间的哪一个部分，通过设置链接器可以改变放置的虚拟地址的位置）。
2. 硬盘只能按扇区对齐读取，一个扇区是512字节。通过访问硬盘控制器并设置相应的命令和参数，就可以从键盘控制器中读取到内存中。
3. 分析ELF结构，从program header中知道段的数量和在磁盘中的位置，通过这些信息将其加载到内存中。