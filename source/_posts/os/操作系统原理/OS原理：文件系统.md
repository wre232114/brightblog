---
title: OS原理：文件系统
date: 2020-01-22 11:37:09
tags:
- 操作系统
- 操作系统原理
- ucore-os

category:
- 操作系统
- 操作系统原理
---
这里文章学习操作系统的原理，主要学习的核心知识点有以下几个：
1. 文件系统的作用和组成成分？
2. 对文件和目录有哪些操作？
3. 文件系统如何实现？包括：
   1. 空闲磁盘空间如何管理和分配？
   2. 如何实现文件到磁盘块的映射管理？
   3. 文件系统如何在磁盘上存储？
4. linux和windows是如何实现文件系统的？

本片文章带着这些问题来复习文件系统的相关的知识，由浅入深。从文件系统解决的问题，到对文件系统的操作，再到文件系统的具体实现方式，再到具体的操作系统的文件系统的设计实现。从原理到实现熟练掌握文件系统。学完原理后，可以分析ucore-os中的文件系统的设计和实现的详细代码（在另一篇文章中，请看![ucore-os-lab8：文件系统设计分析](#)）。本文参考自《现代操作系统》一书，添加了自己的理解。

## 文件系统的作用和组成成分
在计算机运行时，数据基本都是存储在内存（RAM）中的，RAM中的数据具有易失性，当进程退出或者计算机掉电的时候就会丢失数据。磁盘等设备能够长时间存储数据，即使断电，所以一般用磁盘、U盘、光盘等设备来进行长期的数据存储。

但是磁盘、U盘、光盘等设备的数据储存方式和结构可能完全不一样，操作系统需要能够处理这些不同的设备。文件系统需要解决的第一个问题，就是设备的抽象性，例如，我的电脑上插了硬盘、U盘、SSD三块设备，但是我希望以相同的方式来管理和访问三个不同的设备。例如windows上的文件系统，当新插入一个硬盘/光盘/U盘时，会分配一个新的盘符，该盘符的访问和其他所有盘符的访问方式完全相同。

这就出现了文件系统的两层抽象，第一层屏蔽不同硬件的差异；第二层屏蔽不同文件系统的差异。第一个问题通过设计适合不同设备的不同文件系统解决。第二个问题通过虚拟文件系统（VFS）解决。后文会详细讨论这两个问题的解决方案。

文件系统最关键的两个组成元素就是文件和目录。文件和目录都是抽象的概念，一个文件表示一个逻辑上的数据集合；一个目录能够包含其他目录和文件，是一种层级上的抽象。对于操作系统用户来说，直接操作的接口就是文件和目录接口，需要存储的数据以文件为基础单位，通过目录来对文件进行组织和区分。例如希望保存联系人列表，可以创建contact.txt文件、numbers.txt文件；创建短信列表，可以创建message.xml文件；然后通过目录来区分联系人列表或者短信。

还有其他的元素例如`字符特殊文件`和`块特殊文件`，`字符特殊设备`将特殊的字符流设备例如打印机映射到文件系统，通过对对应的文件进行读写就可以读写对应的设备。这里只讨论普通文件。

对于文件还有不同的抽象方式，例如可以将文件视做字节序列，或者记录块或者树结构。第一种方式，字节序列方式，是windows和linux都采用的方式，就是对于用户来说，从操作系统读取出来的文件都是字节序列，如何解释这些字节序列由用户程序决定。第二种方式以“记录”的形式，每一个记录拥有特定的结构和大小，这种方式限制了文件能够存储的类型，一般用于专用的文件系统。第三种方式是树形结构，和上一种结构类似，也是采取一种特殊的查找树的方式来组织文件，通过键来快速查找文件，文件的结构也是特殊的，一般用于专用的文件系统。

## 文件和目录的信息和操作
前面提到了文件和目录的概念，文件是逻辑上的数据集合，目录是文件和目录的集合。文件是存储的基本单位，所有信息通过文件来存储，通过目录来组织，文件系统肯定会提供与文件和目录有关的操作，用来管理文件和目录；肯定会提供文件的信息，例如文件大小、文件类型、文件所有者、文件名等等。

普通文件一般分为二进制文件和文本文件。一般的可执行文件例如ELF文件就是二进制文件。磁盘中存储的都是二进制数据，二进制文件和文本文件只是应用程序对磁盘输入的二进制流的解释方式不同。文本文件一般存的是字符编码后的结果，例如ASCII、UTF-8、GBK等等。

### 文件和目录信息
为了便于区分文件，肯定需要为文件取名字；文件名一般由`名字+后缀`组成，例如contact.txt，`.txt`是后缀，一般用于表示文件的类型。windows下在操作系统层面区分后缀。linux后缀只是在用户程序中区分。一个简单的例子，windows下只有`.exe`文件才可执行，而linux下只要赋予的`x`（可执行）权限的文件都可以执行（当然如果文件内部不是可执行文件的格式会报错）；用户层面区分的例子比如C编译器只接受输入为`.c`后缀的文件。

文件名的长度在不同的操作系统中不同，一些操作系统只支持最大固定长度的文件名和后缀，例如DOS是8+3，最新的操作系统的文件名长度限制会更大，例如256个字符。

常见的文件属性如下：
* 保护：谁能访问文件，文件是否能执行等
* 口令：文件访问需要的密码
* 创建者
* 所有者：拥有该文件的用户、群组等
* 只读标识
* 隐藏标识
* 大小
* 创建时间
* 最后修改时间
* 最后访问时间
* ...

具体的文件系统实现可能不会具有所有的属性，也可能有更多的属性，由具体的操作系统实现来决定。文件属性描述了操作一个文件所需要的信息，任何和文件有关的、用户需要的信息都可以作为文件的属性。

目录描述了文件和目录的层次结构信息，例如一个目录下的结构可能如下：
```
                  user
                  /  \
                all   bright.txt
               /  \
             1.c  hello.js 
```

如上例，user目录下有一个目录all和一个文件bright.txt，目录all下又有两个文件：1.c和hello.js。那我要在上述文件结构中找到1.c或者bright.txt怎么办呢？在上述的目录树中我们可以很方便的找到一条从根目录到文件的`路径`，例如`/user/all/1.c`，可以用路径来表示文件在文件系统中的位置，这也是windows和linux采用的方式，不过windows使用`\`作为分隔符，而linux使用`/`。上述这种方式叫做`绝对路径`，另一种方式是相对路径，例如`./user/bright.txt`或`../hello.js`，表示相对于当前位置的路径。

目录的属性和文件类似，在unix系统中，目录是特殊的文件，属性基本都相同。也包含创建者、所有者、创建时间、修改时间等等信息。

### 对文件和目录的操作
有了文件和目录的概念，那么就需要对文件和目录进行操作，常用的操作有：创建、删除、链接、打开、关闭、读取、写入、重命名、链接等等。对于目录还有切换目录。

对于文件和目录通常有以下操作：
* create：创建文件或者目录，主要工作是初始化一些文件属性、将文件添加到文件系统中
* delete：删除文件或者目录，从文件系统中删除文件，可能没有彻底从磁盘删除，视具体实现而定
* get attribute：获取文件属性（unix中的stat）
* set attribute：设置文件属性
* rename：重命名文件或者目录
* link：链接文件或者目录，这里的链接是硬链接，两个文件共享一个i节点，只删除其中一个节点不会导致数据从硬盘删除
* unlink：将i节点的链接数减1，当计数值为0时删除文件

对于文件还有以下操作：
* open：打开文件，文件只有打开后才能读写
* close：关闭文件，一个程序能打开的文件是有限的，文件使用完成后要及时关闭
* read：从文件读取数据
* seek：设置文件读取的位置
* write：向文件写数据
* append：在文件末尾添加数据，可以通过seek来实现

对于目录还有以下操作：
* opendir：打开目录
* closedir：关闭目录
* readdir：读取目录

## 文件系统的实现
文件系统主要实现上面提到的文件系统的特性，第一个是设备无关性，第二个是文件系统无关性。设备无关性通过文件系统来保证，文件系统无关性虚拟文件系统来保证。最顶层的是文件和目录的抽象，用户能够看到的都是对文件和目录的操作，所以文件系统还需要实现统一的文件目录操作的接口。除此之外，还有整个文件系统的在磁盘的布局，因为文件系统中的所有信息都是需要能够永久保存的，所以文件和目录的属性、结构、包括文件本身都需要存放在磁盘中，以达到永久保存的目的。如何布局这些数据在磁盘中的存储也是一个很重要的问题。文件系统的层级结构如下图：

```
                   用户进程-->系统调用->|             用户空间
-------------------------------------|-----------
                     文件目录操作 <----|   文件目录    内核空间
         file接口 <----|                  抽象层
          |
          |->虚拟文件系统操作               虚拟文件系统
                |->inode接口、vfs接口      抽象层（可以有多个具体文件系统层实现并挂载）
                               | 
         具体文件系统对磁盘的操作<-|         具体文件系统
          |->vfs接口的实现                     层       
              |
              |                              
|超级块|空间磁盘空间管理|i节点|根目录|未使用|  磁盘上的文件系统布局   
     
```

下面我们会自顶向下讨论文件系统的实现，从用户空间的系统调用，内核的进程结构中的文件，到内核的文件、目录抽象，到内核的虚拟文件系统的实现，再到具体文件系统的实现及磁盘上的布局管理。每一层都会提供一定的抽象，通过下层的不同实现来兼容不同的设备或者文件系统。接下来首先介绍整个文件系统的工作过程，先整体了解，细节放在后面单独的小节中。

首先是用户空间的使用，在用户空间能够看到的是文件系统提供的最顶层的抽象——文件和目录，对于用户空间来说文件就是一串二进制数据，并不关系这文件在磁盘上是如何存储和读取的。用户空间通过一系列系统调用来实现对文件和目录的操作，也就是用户直接调用的上图中的文件目录抽象层。该层实现了对于抽象文件的所有操作，例如上面提到的打开、关闭、删除文件等等。主要依赖的数据结构是file接口，也就是最顶层的文件抽象结构，其主要的属性是和文件相关的信息，例如可读写、大小、以及与下一层关联的接口等。

下面是虚拟文件系统层，该层的主要作用是实现文件系统无关性的抽象。虚拟文件系统层定义了一系列对具体文件系统的操作，由具体文件系统来实现以此来实现提供文件目录抽象层使用的统一的底层接口。不同的具体文件系统通过叫做`挂载`的操作接入虚拟文件系统，`挂载`到虚拟文件系统后，上层便可以以统一的方式来访问这些具体文件系统，而不关心文件系统的细节。file接口只定义文件的属性，文件的实现和操作的抽象都在虚拟文件系统层定义。

具体文件系统层是虚拟文件系统层的具体实现，虚拟文件系统层会定义具体文件系统的操作抽象、存储抽象、文件路径抽象，由具体文件系统层来实现。具体文件系统层定义了文件如何在磁盘上存储、如何将文件写入磁盘，如何从磁盘读取文件。

### 文件和目录的实现
前面讲了一个操作系统大概的文件系统层级结构，接下来从原理的角度来分析文件和目录的实现。

文件的实现有多种，第一种是连续分配，需要分配多个连续的磁盘块来满足文件的需要。这种方式的优点是文件读取块，因为文件存在相邻的磁盘块，减少了寻道时间。缺点是会导致磁盘碎片问题，因为当磁盘不断被分配和回收之后，磁盘空闲空间碎片化，这样会导致几个问题，一个是空闲空间分散，可能没有足够的连续空间来分给一个较大的文件，尽管可能总空闲空间大小远大于需要的磁盘大小；另一个是碎片化导致寻道时间增长，磁盘访问变慢导致系统卡顿。还有一个缺陷就是空洞问题，有时候可能需要增长的文件，文件大小不是预先知道的，碎片分割的空洞严重限制文件的大小增长能力。