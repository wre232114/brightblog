---
title: 1.数据库系统导论
date: 2020-02-05 08:38:53
tags:
- 数据库
- 导论

category:
- 数据库
- 导论
---
顾名思义，数据库就是存储数据的仓库，是信息的集合。这些数据一定是能够长期存储的，不会因断电而丢失，所以数据库中的数据一般存储在磁盘等永久存储器材中，而不是RAM（随机访问内存，或者运行内存，断电会丢失数据）中。当然现在有一些No-SQL数据库例如redis用作缓存，是存放在RAM中的，这种缓存数据库和持久数据库不同，这一系列复习笔记主要关注的是持久数据库。缓存数据库在另外的笔记中学习。

## 数据库漫谈
数据库的能力一般通过数据库管理系统来使用，这种软件被称为DBMS（Database Manage System，数据库管理系统），DBMS一般会提供命令行或者图形界面的方式来操作数据库系统中的数据。DBMS中实现了数据库系统的基本能力，例如持久存储，事务处理，提供程序访问接口等。同时能够提供对于数据库进行增删改查的功能、能够有效处理数据库访问时不同用户并发访问的问题。

为了简化数据库的使用和提高数据库操作的性能，一般会提供用于数据库操作的特殊语言，例如用于描述数据库的数据库定义语言，用于查询和更新的语言（比如SQL）。对于**文件系统**而言，文件系统能够提供持久存储的能力，也能够新增删除数据。但是一般的操作系统，不会提供对于文件系统的查询语言，我们要从数以亿计的文件中找出特定文件中的特定一个数据字段，几乎是不可能的。而且文件系统对于数据模式的支持仅仅限于文件夹。所以文件系统虽然能够提供持久存储和一定的数据访问能力，但是远远到不到数据库系统的要求。数据库系统需要进一步的设计。

个人pc或者一般的linux服务器上使用的数据库，例如mysql，底层是使用文件系统实现的。例如新建一个数据库，DBMS会在操作系统中创建一个新的文件并设置其初始大小，例如4G。数据库的细节存储在该文件中，一般不直接访问硬盘，需要调用操作系统提供的文件系统API。但是特定的数据库服务器上会搭载特定的系统，数据库系统能够直接访问硬盘，以提供更高的数据存储效率。

DBMS的一个很重要的特性就是能够快速存取一些小块的数据，例如对于机票、酒店等订票系统，要能够存取每一个订单的日期、价格、起始地点等等信息，对于银行需要存储客户的信息，以及它们的存款、交易记录等等。数据库系统需要提供能很方便快捷的方式来访问其中的某一条或者数条数据，例如输入一个高级语言语句`select age from user where name = 'john'`，就能找到john的年龄，而不是在一大堆文件中找john，再去找john的年龄。

相信大家一定都有找一大堆文件找不着需要的文件的经历，是不是耗时耗神还找不着？大家的解决方案是什么呢？是不是一般是分类分文件夹来存放文件，一个文件夹不存放大量的文件。这种行为背后的思想是什么呢？索引。我们要找一个文件，首先找到那个文件夹，其实就是根据文件找到索引，我知道这个文件属于哪一个索引（文件夹），就能快速找到它。数据库的底层其实也是这么实现的，借助了索引树这样的数据结构。大家找文件时的另一问题是，按照什么顺序来找文件呢？从前到后，还是从后到前，还是从中间开始呢？一般都是从前到后或者从后到前，这样的查找方式叫做线性查找，最坏的情况下需要将所有文件过一遍才能找到（因为可能要找的文件在最后面或者最开始）。而如果我们将文件按照文件名进行排序呢？（windows下文件夹下右键可以设置）例如我们要找`notes.txt`这个文件，它的首字母是n，那么我们是不是可以跳着看呢？先看中间，如果看到了一个l开头的，那么n在l后面，前面的就不用看了，看l后面的文件找`notes.txt`就行了，如此重复。这种查找方式叫做二分查找，假如有n个文件，最坏只需要看$log_2n$次，而线性查找需要看n次。假如n是128，那么$log_2n=7$，对于128个文件，最多只要次就能找到，想想字典就能理解了。

上面提到的一些技术都是数据库底层使用的技术，索引技术，查找算法。这样的技术也是从日常生活遇到的痛点问题而来中，不仅艺术源于生活，技术也源于生活--。那么在日常的电脑使用中，是不是也可以使用一些个人数据库系统（例如access）来解决一些数据管理的问题呢？答案是肯定的，当然是不是使用是需求而定，当你快要为数据管理而抓狂的时候，就可以考虑使用了。当然利用文件夹分类，名称、时间排序的方式是最简便和最常用的方式，对于大多数人而言。

言归正传，对于目前最流行的数据库，使用的都是关系数据库模式。关系数据库的核心思想是以一种类似表格的方式来组织数据，例如对于机票系统，存储的信息可能是下面这样：
```
-----------------------------------------------------
airline | name   | id-number | price | from | arrive-at
-----------------------------------------------------
gh2634  | bright | 430xxx    | 639   | CS   | Tianjin
....
-----------------------------------------------------
```
关系数据库将一条记录的相关信息组织成“一行”，当我们查找某些数据，例如bright将乘坐的航班的“price”的时候，先找到bright所在的那一行，然后再在这一行中找相应的price。“表头”称为模式，模式在数据库表建立的时候确定，可以在建立之后更改。那么问题又来了，既然数据库也是以“表格“的形式来存储，为什么不直接用excel呢？首先，两者用途不同，excel是个人电脑上的办公软件，而数据库一般是运行于服务器上的服务器软件。其次，存储的数据量不同，excel表格最多也就存几万条数据，而商用数据库中的数据都是数以亿计。两者具有相似的存储模式，但是用途不一样决定了两者的功能和实现天差地别。

前面提到的一些例子都是文本，但是在实际中我们会遇到很多非文本数据例如视频、音频等。这些多媒体数据在数据库中如何存储呢？一种方式就是存储多媒体文件的路径，还有一种方式是将多媒体文件直接存入数据库中。后面文章会详细讨论多媒体数据在数据库中的存储和读取问题（以mysql为例）。

## 数据库管理系统
前面提到了数据管理系统（DBMS）是数据库管理的软件，提供了完整的数据库功能。对于数据库用户而言提供的最重要的几个功能是：
* 数据查询和更新
* 数据模式定义
* 事务管理

上述的功能是用户关心的，用户只需要输入特殊的命令或者语句，就能定义数据模式，查询更新数据，开启事务，而不关心数据库底层的的运行。而对于数据库实现，则需要对输入的命令进行解析然后执行。同时要能够进行并发控制、事务管理、日志恢复等。一个DBMS的结构一般如下：
```
用户/应用程序                  数据库管理员
    |     \                       | DDL命令
    |查询   \ 事务命令              |
    |更新    \                     |
    |        \                    |
查询编译器    事务管理器          DDL编译器
    |          | \             /
    |   -------|--------------/
    | /        |    \-----------|
执行引擎---->日志与恢复        并发控制
    |                           |
    |                           |
    |                           |
    |                           |
索引/文件/                存有索状态的表（在内存中）
记录管理器
    |
    |
缓冲区管理器
    |
    |
存储器管理器
    |
    |
  存储器
```
上图显示了一个数据库系统的详细结构，接下来自顶向下分析：
* 最顶层是用户/应用程序，和数据库管理员。可以将他们统一认为是数据库用户，不过一个操作数据，一个操作数据库
* 下一层是直接与上一部分对接，查询编译器用于编译用户输入的命令语句，编译成树结构并制定查询计划。事务管理器用于进行事务调度，调用下一层的并发控制模块。DDL编译器将DDL命令翻译成语法树结构并提交给执行引擎
* 再下一层是执行引擎、日志恢复、并发控制。执行引擎用于执行用户输入的各种命令，会与其他的大多数模块打交道，例如调用调度器避免并发修改数据；调用日志模块回滚事务。同时会调用底层的功能，实现对具体数据的访问。
* 下面的存储器管理器和缓冲区管理器主要的功能是控制存储器和缓冲区的访问。

用户见到的最影响系统性能的DBMS部分是查询处理器，查询处理器包括两个部分：
* 查询编译器：将查询转为内部使用的查询计划，查询计划是在数据上的操作序列。通常查询计划中的操作数用“关系代数”实现。查询编译器由三个模块组成：查询分析器、查询预处理器、查询优化器。查询编译器利用元数据和数据统计确定哪种操作序列最快，例如，如果数据模式中使用了索引，那么将使用索引相关的操作大大检查查询时间。
* 执行引擎。执行引擎负责执行查询计划的每一步。执行引擎和系统中其他的大部分模块交互。因为用户的命令编译后在执行引擎中执行，执行引擎必须访问日志模块以读写日志实现事务的一致性。必须访问调度器来避免访问已加锁的数据。
* 
### 事务管理
数据库中一个非常重要的部分就是事务处理，事务具有的特性有原子性（Atomic）、隔离性（Isolation）、持久性（duration）、一致性（Consistence）。一般用ACID来表示，具体如下：
* 原子性（A）：事务要不全部执行，要不不执行
* 隔离性（I）：表现为同时只有一个事务在执行，多个事务可以同时执行，但是必须保证同时执行的部分是互不影响的。看起来和单独按序执行没有区别
* 持久性（D）：事务一旦完成，影响是持久存在的。
* 一致性（C）：一致性是指事务中的数组元组之间的联系具有一致性，例如一个表中的id，是另一个表中的外键，那么这两个值应该是严格相等的。范围更广的一致性还包括数据的合法性，例如金额一般不是负数等。

事务管理要解决的三个问题是：
* 记日志：日志用于数据库崩溃后的恢复和事务失败回滚的恢复。
* 并发控制：控制数据的并发访问，一般是使用锁的方式。
* 消除死锁：利用锁来控制数据的并发访问可能会导致死锁的问题，所以事务管理器一定要能够消除死锁并将系统恢复到一个一致的状态。


## 数据库系统研究概述
数据库系统的研究方向主要有以下三个：
* 数据库设计：如何设计一个数据库，包括数据库应该存什么样的信息？如何组织？数据项之间如何链接？如何设计没有冗余、一致的数据结构？
* 数据库程序设计：研究如何在应用程序中使用数据库提供的功能，包括如何使用事务管理等功能？数据库设计如何与普通程序设计结合？常用的web系统都属于此类
* 数据库系统实现：研究数据库系统的底层实现，包括如何实现事务管理？如何实现日志系统？如何实现锁机制、采用何种锁？数据如何存储在磁盘上？

这一系列复习笔记参考了《数据库系统大全》一书，会全部涉及到上面三个方向，从数据库设计方法原则，到数据库程序设计，再到数据库底层的实现。

数据库设计上会复习E/R模型、关系数据库模型、函数依赖和设计范式、对象数据库设计和XML等。数据库程序设计上会复习关系代数、SQL语言、高级语言访问数据库。数据库系统实现主要关注三个方面：1.存储器管理。2.查询处理。3.事务管理。

## 总结
这篇文章主要概述了数据库系统解决的问题，主要包括以下几个方面：
* 持久存储数据、高效查询更新数据、自定数据模式
* 事务处理的ACID原则
* 数据库的几个研究/学习方向

接下来的复习，希望能深入理解数据库系统从外到内的方方面面。从数据库设计到数据库应用程序设计，再到数据库底层的实现原理，都能了然于心。